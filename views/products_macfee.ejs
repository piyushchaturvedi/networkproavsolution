<%- include('_header', { pageTitle: pageTitle, activePage: 'products' }) %>

<section class="product-page">
  <h1>Macfee Antivirus Products</h1>

  <% if (groupedProducts && Object.keys(groupedProducts).length > 0) { %>
    <% for (const category in groupedProducts) { %>
      <div class="product-category">
        <h2><%= category %></h2>
        <div class="product-grid"> <!-- This is the div that needs to be the grid container -->
          <% groupedProducts[category].forEach(product => { %>
            <div class="product-card">
              <span class="badge">Sale!</span>
              <a href="/product/<%= product.id %>">
                <img src="<%= product.image %>" alt="<%= product.name %>">
              </a>
              <h3><%= product.name %></h3>
              <p class="price"><del>$<%= product.oldPrice.toFixed(2) %></del> <span>$<%= product.price.toFixed(2) %></span></p>
              <p class="save">SAVE <%= product.savePercent %>%</p>
              <div class="stars">
                  <% for (let i = 0; i < Math.floor(product.rating); i++) { %>⭐<% } %>
                  <% if (product.rating % 1 !== 0) { %><span class="half">½</span><% } %>
              </div>
              <!-- Truncated Description -->
              <p class="product-description" data-full-description="<%= product.shortDesc %>">
                  <%= product.shortDesc.substring(0, 80) %><% if (product.shortDesc.length > 80) { %>... <span class="view-more-link" data-product-id="<%= product.id %>">View More</span><% } %>
              </p>
              <button class="add-to-cart-button" data-product-id="<%= product.id %>">ADD TO CART</button>
              <div id="message-<%= product.id %>" style="color: green; font-size: 0.8em; margin-top: 5px;"></div>
            </div>
          <% }); %>
        </div>
      </div>
    <% } %>
  <% } else { %>
    <p style="text-align: center;">No McAfee Antivirus products found.</p>
  <% } %>

</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const addToCartButtons = document.querySelectorAll('.product-card .add-to-cart-button');
        const viewMoreLinks = document.querySelectorAll('.view-more-link');

        addToCartButtons.forEach(button => {
            const productId = button.dataset.productId;
            const messageDiv = document.getElementById(`message-${productId}`);

            button.addEventListener('click', async (event) => {
                event.stopPropagation();
                try {
                    const response = await fetch('/cart/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ productId: productId, quantity: 1 }),
                    });
                    
                    const data = await response.json();

                    if (response.ok) {
                        messageDiv.textContent = data.message;
                        messageDiv.style.color = 'green';
                        messageDiv.style.display = 'block';
                        setTimeout(() => { messageDiv.style.display = 'none'; }, 2000);
                        window.location.reload(); 
                    } else {
                        messageDiv.textContent = data.message || `Error: ${response.statusText}`;
                        messageDiv.style.color = 'red';
                        messageDiv.style.display = 'block';
                        console.error('Server error response:', data);
                    }
                } catch (error) {
                    console.error('Error during Add to Cart fetch:', error);
                    messageDiv.textContent = 'An error occurred during network request. Please try again.';
                    messageDiv.style.color = 'red';
                    messageDiv.style.display = 'block';
                }
            });
        });

        viewMoreLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.stopPropagation();
                const productId = link.dataset.productId;
                window.location.href = `/product/${productId}`;
            });
        });
    });
</script>

<%- include('_footer') %>
